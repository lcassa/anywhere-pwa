define(["exports"],function(_exports){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.PouchdbBinder=_exports.$pouchdbBinder=void 0;var PouchdbBinder=function(){babelHelpers.createClass(PouchdbBinder,null,[{key:"properties",get:function get(){return{docRegistry:{type:Object,value:null,reflectToAttribute:!0,notify:!0,readonly:!1},db:{type:Object,value:null}}}}]);function PouchdbBinder(){babelHelpers.classCallCheck(this,PouchdbBinder);this.docRegistry={}}babelHelpers.createClass(PouchdbBinder,[{key:"_getIndex",value:function _getIndex(context,collectionAlias,itemId){return context.get(collectionAlias).map(function(item){return item._id}).indexOf(itemId)}},{key:"_findRegistries",value:function _findRegistries(registryId){var response=[];for(var key in this.docRegistry){if(this.docRegistry[key][registryId]){response.push(key)}}return response}},{key:"_registerDbListener",value:function _registerDbListener(db){this.db=db;var that=this;this.db.changes({since:"now",live:!0,include_docs:!0}).on("change",function(change){if(!change.doc.resourceName){return}var registries=that._findRegistries(change.id);if(0<registries.length){for(var i=registries.length-1,registry;0<=i;i--){registry=that.docRegistry[registries[i]][change.id];for(var j=registry.contexts.length-1;0<=j;j--){var currContext=registry.contexts[j],collection=currContext.get(registry.collectionAlias);if(Array.isArray(collection)){var index=that._getIndex(currContext,registry.collectionAlias,change.id);if(change.deleted){currContext.splice(registry.collectionAlias,index,1)}else{currContext.set([registry.collectionAlias,index],change.doc)}}else{currContext.set(registry.collectionAlias,change.doc)}}}}else{if(change.deleted){return}var resourceName=change.doc.resourceName;if(resourceName&&that.docRegistry[resourceName]&&0<Object.keys(that.docRegistry[resourceName]).length){var aKey=Object.keys(that.docRegistry[resourceName])[0],aRecord=that.docRegistry[resourceName][aKey];if(!aRecord.contexts[0].inputOn){}that.bindDoc(change.doc,aRecord.collectionAlias,resourceName,aRecord.contexts[0])}else{console.log("Collection ".concat(resourceName," exists but with no records to it"))}}}).on("error",function(err){console.error(err);throw err})}},{key:"bindDocs",value:function bindDocs(collectionAlias,collectionName,context){var that=this;if(!that.docRegistry[collectionName]){that.docRegistry[collectionName]=[];context._observeCollection=function(result){if(!result||0==result.length){return}var docsToBind=null;if(result.indexSplices){var splices=result.indexSplices;docsToBind=splices[0].object.slice(splices.index,splices.index+splices.addedCount)}if(0<result.length){docsToBind=result}docsToBind.map(function(entry){that.bindDoc(entry,collectionAlias,collectionName,context)},that)};context._createMethodObserver("_observeCollection(".concat(collectionAlias,".splices)"),!0);context._createMethodObserver("_observeCollection(".concat(collectionAlias,")"),!0)}}},{key:"bindDoc",value:function bindDoc(docToBind,collectionAlias,collectionName,context){if(!this.docRegistry[collectionName]){this.docRegistry[collectionName]=[]}this._registerDoc(docToBind._id,collectionAlias,collectionName,context)}},{key:"_registerDoc",value:function _registerDoc(id,collectionAlias,collectionName,registryContext){var currRegistry;if(currRegistry=this.docRegistry[collectionName][id]){if(!currRegistry.contexts.includes(registryContext)){currRegistry.contexts.push(registryContext)}}else{this.docRegistry[collectionName][id]={collectionAlias:collectionAlias,collectionName:collectionName,contexts:[registryContext]}}}}]);return PouchdbBinder}();_exports.PouchdbBinder=PouchdbBinder;_exports.$pouchdbBinder={PouchdbBinder:PouchdbBinder}});